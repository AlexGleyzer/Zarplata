\# DOMAIN.md

\## Доменна модель ядра "Зарплата"



Цей документ описує \*\*сутності та інваріанти\*\* домену.  

Увесь код доменного ядра має відповідати цій моделі.



---



\## 1. Основні сутності



\### 1.1. Працівник (Employee)



\*\*Сенс:\*\* людина, для якої робимо нарахування/утримання.



Має (на концептуальному рівні):



\- ідентифікатор працівника

\- ПІБ / код

\- статуси в часі (прийняття, звільнення, переведення)

\- категорії, що впливають на розрахунок:

&nbsp; - інвалід / не інвалід

&nbsp; - неповнолітній

&nbsp; - ставка / повна зайнятість

&nbsp; - інші пільги



\*\*Інваріанти:\*\*



\- на будь-яку дату працівник має або “активний” статус, або не враховується в розрахунках за цю дату

\- зміни статусів/категорій зберігаються як історія (не перезаписуються)



---



\### 1.2. Тип операції (AccrualType)



\*\*Сенс:\*\* класифікація того, ЩО це за операція.



Приклади:



\- `SALARY` — основна зарплата

\- `BONUS` — премія

\- `VACATION` — відпустка

\- `SICK` — лікарняні

\- `MATERNITY` — декретні

\- `PIT` — ПДФО

\- `WAR\_TAX` — військовий збір

\- `ESV\_EMPLOYEE` — ЄСВ за працівника

\- `ESV\_EMPLOYER` — ЄСВ роботодавця



\*\*Властивості:\*\*



\- код типу (стабільний ідентифікатор)

\- назва / опис

\- напрямок:

&nbsp; - нарахування доходу

&nbsp; - утримання з працівника

&nbsp; - внесок роботодавця

\- категорія:

&nbsp; - дохід

&nbsp; - податок

&nbsp; - внесок

&nbsp; - компенсація

&nbsp; - тощо



\*\*Інваріанти:\*\*



\- код типу унікальний

\- кожна операція нарахування/утримання посилається на якийсь тип



---



\### 1.3. Версія правила типу (RuleVersion)



\*\*Сенс:\*\* конкретне правило розрахунку для певного типу в певний період часу.



\*\*Властивості (концептуально):\*\*



\- посилання на `AccrualType`

\- період дії:

&nbsp; - дата початку дії (включно)

&nbsp; - дата закінчення дії (може бути “безкінечність”)

\- опис алгоритму:

&nbsp; - людський опис (як пояснює бухгалтер)

&nbsp; - формалізований опис / формула / DSL (чим користується ядро)

\- інформація про базу:

&nbsp; - від чого рахується (оклад, середня, мінімалка, база оподаткування тощо)

\- обмеження:

&nbsp; - ліміти мін/макс

&nbsp; - входить чи ні до бази інших податків



\*\*Інваріанти:\*\*



\- у часі \*\*не повинні перетинатися дві активні версії одного типу з однаковими умовами\*\*  

\- при зміні законодавства:

&nbsp; - стара версія закінчує період дії

&nbsp; - нова версія починає діяти з нової дати

\- старі версії ніколи не редагуються заднім числом (тільки нові записи)



---



\### 1.4. Нарахування (AccrualOperation)



\*\*Сенс:\*\* конкретна подія “ми нарахували X за такий-то період”.



Це \*\*одна боргова історія\*\*.



\*\*Властивості:\*\*



\- унікальний код операції (ідентифікує цю боргову подію)

\- посилання на працівника (або на “одержувача”/“платника”, якщо це податок)

\- посилання на `AccrualType`

\- посилання на конкретну `RuleVersion`, за якою рахували

\- період нарахування:

&nbsp; - дата початку

&nbsp; - дата закінчення

\- загальна сума нарахування (total)

\- деталізація по підперіодах (див. нижче `AccrualPart`)



\*\*Інваріанти:\*\*



\- `total` = сума всіх пов’язаних частин (`AccrualPart`)

\- період нарахування повинен бути повністю покритий частинами без перекриттів

\- нарахування не редагується “в лоб” — у разі помилки створюється коригуюча операція (сторно/донарахування)



---



\### 1.5. Частина нарахування (AccrualPart)



\*\*Сенс:\*\* фрагмент нарахування для підперіоду, де база і правила сталі.



\*\*Властивості:\*\*



\- посилання на `AccrualOperation`

\- підперіод:

&nbsp; - дата початку

&nbsp; - дата закінчення

\- використана база:

&nbsp; - оклад/ставка/середня/мінімалка

&nbsp; - ставка (%) податку

&nbsp; - інші параметри

\- сума нарахування за цей підперіод



\*\*Інваріанти:\*\*



\- підперіоди не повинні перекриватись для однієї операції

\- обʼєднано всі підперіоди = повний період нарахування

\- якщо в межах періоду змінюється база або правило — зʼявляється нова `AccrualPart`



---



\### 1.6. Виплата (PaymentOperation)



\*\*Сенс:\*\* факт того, що частину/всю суму по нарахуванню виплачено.



\*\*Властивості:\*\*



\- дата виплати

\- сума

\- посилання на одну або кілька `AccrualOperation` (мінімум — одна)

\- тип одержувача:

&nbsp; - працівник

&nbsp; - бюджет (податок)

&nbsp; - фонд

\- спосіб/канал (банківський рахунок, каса тощо — опціонально)



\*\*Інваріанти:\*\*



\- для кожної `AccrualOperation`:

&nbsp; - `сплачено\_сума` = сума всіх виплат, які її стосуються

&nbsp; - `борг` = `нараховано` - `сплачено` ≥ 0

\- виплата не може збільшити сплачено більше, ніж нараховано (або система повинна це явно відображати як переплату)



---



\### 1.7. База (TaxBase / CalculationBase)



\*\*Сенс:\*\* набір величин, від яких залежать обчислення:

\- оклади

\- ставки

\- мінімальні/максимальні бази

\- спец-параметри для категорій працівників



\*\*Властивості (концептуально):\*\*



\- тип бази (оклад, мінімальна зарплата, база ЄСВ, прожитковий мінімум тощо)

\- значення

\- період дії (з дати по дату)

\- можлива привʼязка до конкретного працівника / категорії



\*\*Інваріанти:\*\*



\- для кожного типу бази в межах однієї “області дії” (країна/категорія/працівник) не повинно бути двох записів, що суперечать один одному на одну й ту саму дату

\- під час розрахунку на певну дату існує або одна актуальна база, або розрахунок явно фіксує, що бази немає



---



\### 1.8. Версія схеми БД (SchemaVersion / SystemMeta)



\*\*Сенс:\*\* службова сутність, яка каже, в якому стані зараз структура БД.



\*\*Властивості:\*\*



\- поточна версія схеми (ціле число)

\- історія міграцій (які уже застосовано)



\*\*Інваріанти:\*\*



\- зміна версії відбувається тільки через міграції

\- перед зміною версії БД має бути зроблена резервна копія



---



\## 2. Ключові інваріанти на рівні системи



1\. \*\*Історичність\*\*

&nbsp;  - жодні історичні дані не перезаписуються “по-тихому”

&nbsp;  - зміни робляться через нові записи або коригуючі операції



2\. \*\*Детермінованість\*\*

&nbsp;  - однаковий набір вхідних даних (стан правил, баз, статусів, періодів)  

&nbsp;    → завжди дає однаковий результат розрахунку



3\. \*\*Розбиття на підперіоди\*\*

&nbsp;  - якщо в межах періоду змінюється база або правило (або статус працівника, що впливає на алгоритм)  

&nbsp;    → система \*\*зобовʼязана\*\* розбити період на підперіоди і порахувати кожен окремо



4\. \*\*Відокремлення нарахувань і виплат\*\*

&nbsp;  - нарахування і виплати — різні сутності

&nbsp;  - стан “сплачено/частково/борг” — це результат обчислень, а не флаг у таблиці



5\. \*\*Версіонування правил\*\*

&nbsp;  - правила розрахунку не змінюються заднім числом

&nbsp;  - нове законодавство = нова версія правила з новим періодом дії



6\. \*\*Стабільність схеми\*\*

&nbsp;  - зміни в структурі БД робляться тільки через явні міграції

&nbsp;  - користувач може пропустити скільки завгодно версій програми, міграції дотягнуть схему до актуальної версії послідовно



---



\## 3. Що НЕ входить в доменне ядро



\- UI-логіка (форми, кнопки, екрани)

\- framework-специфічні речі (controllers, routes, ORM-entity тощо)

\- технічні деталі зберігання (SQLite, інші СУБД)

\- механізм автооновлення (це інфраструктурний рівень)



Ядро працює тільки з:

\- сутностями домену

\- періодами

\- базами

\- правилами

\- операціями нарахувань/виплат



