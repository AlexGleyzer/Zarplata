# ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ñ–Ñ SCOPE - ĞĞ±Ğ»Ğ°ÑÑ‚Ñ– Ğ—Ğ°ÑÑ‚Ğ¾ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ

## ĞĞ³Ğ»ÑĞ´

**Scope (Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ Ğ·Ğ°ÑÑ‚Ğ¾ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ)** - Ñ†Ğµ Ğ¼ĞµÑ…Ğ°Ğ½Ñ–Ğ·Ğ¼, ÑĞºĞ¸Ğ¹ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” ÑÑ‚Ğ²Ğ¾Ñ€ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿ĞµÑ€Ñ–Ğ¾Ğ´Ğ¸, Ğ½Ğ°Ñ€Ğ°Ñ…ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ²Ğ¸Ğ¿Ğ»Ğ°Ñ‚Ğ¸ Ğ´Ğ»Ñ Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… Ñ€Ñ–Ğ²Ğ½Ñ–Ğ² Ğ¾Ñ€Ğ³Ğ°Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ—: Ğ²Ñ–Ğ´ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ Ğ¿Ñ–Ğ´Ğ¿Ñ€Ğ¸Ñ”Ğ¼ÑÑ‚Ğ²Ğ° Ğ´Ğ¾ Ğ¾ĞºÑ€ĞµĞ¼Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºĞ°.

## Ğ¢Ğ¸Ğ¿Ğ¸ Scope

| Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸Ñ | ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´ |
|-----|------|---------|
| `enterprise` | Ğ’ÑĞµ Ğ¿Ñ–Ğ´Ğ¿Ñ€Ğ¸Ñ”Ğ¼ÑÑ‚Ğ²Ğ¾ | ĞĞ°Ñ€Ğ°Ñ…ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ—ĞŸ Ğ²ÑÑ–Ğ¼ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºĞ°Ğ¼ |
| `department` | ĞŸÑ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ» (+ Ğ´Ğ¾Ñ‡Ñ–Ñ€Ğ½Ñ–) | ĞŸÑ€ĞµĞ¼Ñ–Ñ IT-Ğ²Ñ–Ğ´Ğ´Ñ–Ğ»Ñƒ |
| `position` | Ğ’ÑÑ– Ğ½Ğ° Ğ¿Ğ¾ÑĞ°Ğ´Ñ– | ĞĞ°Ğ´Ğ±Ğ°Ğ²ĞºĞ° Ğ²ÑÑ–Ğ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ñ–ÑÑ‚Ğ°Ğ¼ |
| `category` | ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºÑ–Ğ² | Ğ”Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ñ–Ğ½Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ğ¼ |
| `group` | Ğ†Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ° | Ğ‘Ğ¾Ğ½ÑƒÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ– Ğ¿Ñ€Ğ¾Ñ”ĞºÑ‚Ñƒ |
| `employee` | ĞĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸Ğº | ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ° Ğ¿Ñ€ĞµĞ¼Ñ–Ñ |

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ² Ğ‘Ğ”

```sql
-- Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ· scope
CREATE TABLE doc_payroll_calculations (
    ...
    scope_type TEXT DEFAULT 'enterprise',
    scope_id INTEGER,          -- ID Ğ¿Ñ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ñƒ/Ğ¿Ğ¾ÑĞ°Ğ´Ğ¸/Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºĞ°
    scope_filter TEXT,         -- JSON Ğ· Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¼Ğ¸ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸
    ...
);
```

## ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ

### 1. Ğ’ÑĞµ Ğ¿Ñ–Ğ´Ğ¿Ñ€Ğ¸Ñ”Ğ¼ÑÑ‚Ğ²Ğ¾

```sql
INSERT INTO doc_payroll_calculations (
    document_number, period_id,
    scope_type, scope_id
) VALUES (
    'Ğ—ĞŸ-2024-001', 1,
    'enterprise', NULL
);
```

### 2. ĞŸÑ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»

```sql
-- ĞĞ°Ñ€Ğ°Ñ…ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ´Ğ»Ñ IT-Ğ²Ñ–Ğ´Ğ´Ñ–Ğ»Ñƒ (Ğ²ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ· Ğ´Ğ¾Ñ‡Ñ–Ñ€Ğ½Ñ–Ğ¼Ğ¸ Ğ¿Ñ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ğ°Ğ¼Ğ¸)
INSERT INTO doc_payroll_calculations (
    document_number, period_id,
    scope_type, scope_id
) VALUES (
    'Ğ—ĞŸ-2024-002', 1,
    'department', 3  -- ID IT-Ğ´ĞµĞ¿Ğ°Ñ€Ñ‚Ğ°Ğ¼ĞµĞ½Ñ‚Ñƒ
);
```

### 3. ĞŸÑ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ» Ğ‘Ğ•Ğ— Ğ´Ğ¾Ñ‡Ñ–Ñ€Ğ½Ñ–Ñ…

```sql
INSERT INTO doc_payroll_calculations (
    document_number, period_id,
    scope_type, scope_id,
    scope_filter
) VALUES (
    'Ğ—ĞŸ-2024-003', 1,
    'department', 3,
    '{"include_children": false}'
);
```

### 4. ĞĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸Ğº

```sql
INSERT INTO doc_payroll_calculations (
    document_number, period_id,
    scope_type, scope_id
) VALUES (
    'ĞŸĞ Ğ•ĞœĞ†Ğ¯-2024-010', 1,
    'employee', 101  -- ID Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºĞ°
);
```

## Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ Ğ¿Ñ€Ğ°Ñ†Ñ–Ğ²Ğ½Ğ¸ĞºÑ–Ğ² Ğ¿Ğ¾ scope

```javascript
async function getEmployeesByScope(scopeType, scopeId, options = {}) {
    switch (scopeType) {
        case 'enterprise':
            return db.query(`
                SELECT e.* FROM employees e
                JOIN employee_assignments ea ON ea.employee_id = e.id
                WHERE e.is_active = 1 AND ea.is_active = 1
            `);

        case 'department':
            const includeChildren = options.include_children !== false;
            if (includeChildren) {
                return db.query(`
                    SELECT DISTINCT e.* FROM employees e
                    JOIN employee_assignments ea ON ea.employee_id = e.id
                    JOIN departments d ON d.id = ea.department_id
                    JOIN departments parent ON parent.id = ?
                    WHERE e.is_active = 1
                      AND ea.is_active = 1
                      AND (d.id = parent.id OR d.full_path LIKE parent.full_path || '/%')
                `, [scopeId]);
            } else {
                return db.query(`
                    SELECT e.* FROM employees e
                    JOIN employee_assignments ea ON ea.employee_id = e.id
                    WHERE e.is_active = 1
                      AND ea.is_active = 1
                      AND ea.department_id = ?
                `, [scopeId]);
            }

        case 'position':
            return db.query(`
                SELECT e.* FROM employees e
                JOIN employee_assignments ea ON ea.employee_id = e.id
                WHERE e.is_active = 1
                  AND ea.is_active = 1
                  AND ea.position_id = ?
            `, [scopeId]);

        case 'category':
            return db.query(`
                SELECT e.* FROM employees e
                JOIN employee_category_membership ecm ON ecm.employee_id = e.id
                WHERE e.is_active = 1
                  AND ecm.is_active = 1
                  AND ecm.category_id = ?
            `, [scopeId]);

        case 'group':
            return db.query(`
                SELECT e.* FROM employees e
                JOIN employee_group_members egm ON egm.employee_id = e.id
                WHERE e.is_active = 1
                  AND egm.group_id = ?
            `, [scopeId]);

        case 'employee':
            return db.query(`
                SELECT * FROM employees WHERE id = ? AND is_active = 1
            `, [scopeId]);

        default:
            throw new Error(`Unknown scope type: ${scopeType}`);
    }
}
```

## ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñƒ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ñ– Scope

Ğ”Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸ Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ¾Ğ±Ğ¼ĞµĞ¶ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑŒ scope:

```sql
-- Ğ‘ÑƒÑ…Ğ³Ğ°Ğ»Ñ‚ĞµÑ€ Ğ¼Ğ¾Ğ¶Ğµ Ğ½Ğ°Ñ€Ğ°Ñ…Ğ¾Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ñƒ
INSERT INTO role_permissions (
    role_id, permission_id,
    scope_type, scope_id
) VALUES (
    4, 7,  -- accountant, calculations_run
    'department', 3  -- Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ IT-Ğ²Ñ–Ğ´Ğ´Ñ–Ğ»
);
```

## UI ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑƒ

ĞŸÑ€Ğ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñ– scope Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ–:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ”Ğ»Ñ ĞºĞ¾Ğ³Ğ¾?                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â—‹ ğŸ¢ Ğ’ÑĞµ Ğ¿Ñ–Ğ´Ğ¿Ñ€Ğ¸Ñ”Ğ¼ÑÑ‚Ğ²Ğ¾ (67)            â”‚
â”‚ â—‹ ğŸ›ï¸ ĞŸÑ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ» â–¼                      â”‚
â”‚ â—‹ ğŸ’¼ ĞŸĞ¾ÑĞ°Ğ´Ğ° â–¼                          â”‚
â”‚ â—‹ ğŸ‘¥ ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ â–¼                       â”‚
â”‚ â—‹ ğŸ‘¤ Ğ›ÑĞ´Ğ¸Ğ½Ğ° â–¼                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ĞŸÑ€Ğ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñ– "ĞŸÑ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»":

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¯ĞºĞ¸Ğ¹ Ğ¿Ñ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»?                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â— Ğ’ĞµÑÑŒ Ğ¿Ñ–Ğ´Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ» (12)  â† Ğ—ĞĞ’Ğ–Ğ”Ğ˜ ĞŸĞ•Ğ Ğ¨Ğ˜Ğ™â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â—‹ Ğ Ğ¾Ğ·Ñ€Ğ¾Ğ±ĞºĞ° (8)                        â”‚
â”‚ â—‹ Ğ¢ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ (3)                      â”‚
â”‚ â—‹ DevOps (1)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
